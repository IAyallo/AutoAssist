<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoAssist - Service Request</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        .leaflet-container {
            height: 100%;
            width: 100%;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-logo">
            <div class="nav-logo-icon">
                <img src="tool_icon.jpg" alt="AutoAssist Logo" class="logo-image">
            </div>
            <span class="nav-logo-text">AUTOASSIST</span>
        </div>
        <div class="nav-user">
            <div class="nav-avatar" id="user-avatar"></div>
        </div>
    </nav>

    <div class="container">
        <div class="service-flow">
            <div class="step-indicator">
                <div class="step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <div class="step-label">Request</div>
                </div>
                <div class="step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <div class="step-label">Confirmation</div>
                </div>
                <div class="step" id="step4-indicator">
                    <div class="step-number">4</div>
                    <div class="step-label">Tracking</div>
                </div>
                <div class="step" id="step5-indicator">
                    <div class="step-number">5</div>
                    <div class="step-label">Completion</div>
                </div>
            </div>

            <!-- Step 1: Service Request -->
            <div class="card" id="step1">
                <h3 class="card-title">Service Request</h3>
                <p>Describe the problem with your car</p>
                <form id="service-request-form">
                    <div class="form-group">
                        <label for="service-type">Service Type</label>
                        <select id="service-type" required>
                            <option value="" disabled selected>Select service type</option>
                            <option value="breakdown">Breakdown Assistance (KES 7,000)</option>
                            <option value="tire">Tire Change (KES 2,500)</option>
                            <option value="battery">Battery Jumpstart (KES 3,000)</option>
                            <option value="fuel">Fuel Delivery (KES 3,500)</option>
                            <option value="other">Other (KES 2,000)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="problem-description">Problem Description</label>
                        <textarea id="problem-description" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Request Mechanic</button>
                </form>
            </div>

            <!-- Step 2: Location -->
            <div class="card" id="step2" style="display:none;">
                <h3 class="card-title">Confirm Your Location</h3>
                <p>Check if the map shows your correct location</p>
                <div class="map-container">
                    <div id="map-location"></div>
                </div>
                <button id="confirm-location" class="btn btn-primary">Confirm Location</button>
            </div>

            <!-- Step 3: Confirmation -->
            <div class="card" id="step3" style="display:none;">
                <h3 class="card-title">Service Confirmation</h3>
                
                <div class="btn-group">
                    <button id="confirm-no" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-yes" class="btn btn-primary">Confirm</button>
                </div>
                <div class="mechanic-list" id="mechanic-list"></div>
                <table class="mechanic-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Locality</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="mechanic-table-body"></tbody>
                </table>
            </div>

            <!-- Step 4: Tracking -->
            <div class="card" id="step4" style="display:none;">
                <h3 class="card-title">Mechanic En Route</h3>
                <div class="map-container">
                    <div id="map-tracking"></div>
                </div>
                <div class="tracking-info">
                    <p><strong>ETA:</strong> <span id="eta-display">8</span> minutes</p>
                    <p><strong>Distance:</strong> <span id="distance-display">2.5</span> km</p>
                </div>
                <button id="service-started" class="btn btn-primary" disabled>Mechanic Has Arrived</button>
            </div>

            <!-- Step 5: Completion -->
            <div class="card" id="step5" style="display:none;">
                <h3 class="card-title">Service Completed</h3>
                <div class="payment-info">
                    <p><strong>Service:</strong> Battery Replacement</p>
                    <p><strong>Amount:</strong> KES 3,200</p>
                </div>
                <div class="form-group">
                    <label>Rate Your Experience</label>
                    <div class="rating">
                        <span class="rating-star">★</span>
                        <span class="rating-star">★</span>
                        <span class="rating-star">★</span>
                        <span class="rating-star">★</span>
                        <span class="rating-star">★</span>
                    </div>
                </div>
                <button type="button" id="complete-service" class="btn btn-primary">Complete & Pay</button>
            </div>
        </div>
    </div>

    <input type="hidden" id="userPhone" name="userPhone">
    <input type="hidden" id="car_id" name="car_id">
    <input type="hidden" id="locality" name="locality">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let locationMap, trackingMap;
        let userMarker, mechanicMarker;
        let userLocation, mechanicLocation;
        let etaInterval;
        let CURRENT_SERVICE_ID = null;
        let selectedMechanicId = null;
        let selectedRating = 0;

        document.addEventListener('DOMContentLoaded', function() {
            const userName = localStorage.getItem('userName') || 'User';
            document.getElementById('user-avatar').textContent = userName.charAt(0).toUpperCase();

            // Load user details
            document.getElementById('userPhone').value = localStorage.getItem('userPhone');
            document.getElementById('car_id').value = localStorage.getItem('selectedCar'); // or from your car dropdown
            document.getElementById('locality').value = "Nairobi"; // or get from map/geolocation if available

            // Step 1: Service Request
            document.getElementById('service-request-form').addEventListener('submit', function(e) {
                e.preventDefault();
                showStep(2);
                initLocationMap();
            });

            // Step 2: Location
            document.getElementById('confirm-location').addEventListener('click', function() {
                // Set hidden fields
                document.getElementById('userPhone').value = localStorage.getItem('userPhone');
                document.getElementById('car_id').value = localStorage.getItem('selectedCar');
                document.getElementById('locality').value = "Nairobi"; // or get dynamically

                // Get service type and problem description
                const service_type = document.getElementById('service-type').value;
                const problem_description = document.getElementById('problem-description').value;

                // Get user location if available
                let latitude = userLocation ? userLocation[0] : '';
                let longitude = userLocation ? userLocation[1] : '';

                const formData = new FormData();
                formData.append('userPhone', localStorage.getItem('userPhone'));
                formData.append('car_id', localStorage.getItem('selectedCar'));
                formData.append('service_type', service_type);
                formData.append('problem_description', problem_description);
                formData.append('locality', "Nairobi"); // or use actual locality
                formData.append('latitude', latitude);
                formData.append('longitude', longitude);

                fetch('process_service_request.php', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        CURRENT_SERVICE_ID = data.service_id;
                        localStorage.setItem('currentServiceId', CURRENT_SERVICE_ID); // Store for later use
                        showStep(3);
                    } else {
                        alert(data.message || 'Failed to submit request.');
                    }
                });
            });

            // Step 3: Confirmation
            document.getElementById('confirm-yes').addEventListener('click', function() {
                showStep(4);
                initTrackingMap();
                setTimeout(() => {
                    document.getElementById('service-started').disabled = false;
                }, 5000);
            });
            
            document.getElementById('confirm-no').addEventListener('click', function() {
                alert('Service request cancelled');
                window.location.href = 'home.html';
            });

            // Step 4: Tracking
            document.getElementById('service-started').addEventListener('click', function() {
                showStep(5);
                clearInterval(etaInterval);
            });

            // Step 5: Rating
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    selectedRating = index + 1;
                    stars.forEach((s, i) => {
                        s.classList.toggle('active', i <= index);
                    });
                });
            });

            // Complete Service
            document.getElementById('complete-service').addEventListener('click', function(e) {
                e.preventDefault();
                if (selectedRating === 0) {
                    alert('Please rate your experience before completing.');
                    return;
                }
                // Always use the service ID from localStorage for robustness
                const serviceIdToSubmit = CURRENT_SERVICE_ID || localStorage.getItem('currentServiceId');
                alert('Submitting service_id: ' + serviceIdToSubmit + ', rating: ' + selectedRating);
                fetch('complete_service.php', {
                    method: 'POST',
                    body: new URLSearchParams({
                        service_id: serviceIdToSubmit,
                        rating: selectedRating
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem('currentServiceId'); // Clean up after completion
                        alert('Thank you for using AutoAssist!');
                        window.location.href = 'home.html';
                    } else {
                        alert(data.message || 'Failed to complete service.');
                    }
                });
            });

            // Load available mechanics
            fetch('get_available_mechanics.php')
              .then(res => res.json())
              .then(mechanics => {
                const tbody = document.getElementById('mechanic-table-body');
                tbody.innerHTML = '';
                mechanics.forEach(mech => {
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td class="mech-name">${mech.name}</td>
                    <td>${mech.locality}</td>
                    <td><button class="select-btn">Select</button></td>
                  `;
                  // Select mechanic when row or name is clicked
                  tr.querySelector('.mech-name').onclick = () => selectMechanic(mech.mech_id, tr);
                  tr.querySelector('.select-btn').onclick = (e) => {
                    e.stopPropagation();
                    selectMechanic(mech.mech_id, tr);
                  };
                  tbody.appendChild(tr);
                });
              });
        });

        function showStep(stepNumber) {
            document.querySelectorAll('.card').forEach(card => {
                card.style.display = 'none';
            });
            document.getElementById('step' + stepNumber).style.display = 'block';

            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById('step' + i + '-indicator');
                if (i < stepNumber) {
                    step.classList.add('completed');
                } else {
                    step.classList.add('active');
                }
            }
        }

        function initLocationMap() {
            locationMap = L.map('map-location').setView([-1.286389, 36.817223], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(locationMap);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        locationMap.setView(userLocation, 15);
                        L.marker(userLocation).addTo(locationMap);
                        document.getElementById('confirm-location').disabled = false;
                    },
                    () => {
                        document.getElementById('confirm-location').disabled = false;
                    }
                );
            } else {
                document.getElementById('confirm-location').disabled = false;
            }
        }

        function initTrackingMap() {
            if (!userLocation) userLocation = [-1.286389, 36.817223];
            
            trackingMap = L.map('map-tracking').setView(userLocation, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(trackingMap);
            
            L.marker(userLocation).addTo(trackingMap);
            
            mechanicLocation = [userLocation[0] + 0.01, userLocation[1] + 0.01];
            mechanicMarker = L.marker(mechanicLocation, {
                icon: L.divIcon({
                    className: 'mechanic-icon',
                    html: '🔧',
                    iconSize: [30, 30]
                })
            }).addTo(trackingMap);

            let eta = 8;
            etaInterval = setInterval(() => {
                mechanicLocation[0] -= 0.0005;
                mechanicLocation[1] -= 0.0005;
                mechanicMarker.setLatLng(mechanicLocation);
                
                eta = Math.max(1, eta - 1);
                document.getElementById('eta-display').textContent = eta;
                
                if (Math.abs(mechanicLocation[0] - userLocation[0]) < 0.0005) {
                    document.getElementById('service-started').disabled = false;
                }
            }, 3000);
        }

        function selectMechanic(mech_id, row) {
          // Remove selection from all rows
          document.querySelectorAll('.mechanic-table tr.selected').forEach(tr => tr.classList.remove('selected'));
          document.querySelectorAll('.select-btn.selected').forEach(btn => btn.classList.remove('selected'));
          // Highlight selected row and button
          row.classList.add('selected');
          row.querySelector('.select-btn').classList.add('selected');
          selectedMechanicId = mech_id;
          // Optionally, immediately assign or enable a "Confirm Mechanic" button
          assignMechanicToRequest(mech_id);
        }

        function assignMechanicToRequest(mech_id) {
          // Send AJAX to update the service row with the selected mechanic
          fetch('assign_mechanic.php', {
            method: 'POST',
            body: new URLSearchParams({
              service_id: CURRENT_SERVICE_ID, // get this from your flow
              mech_id: mech_id
            })
          }).then(res => res.json())
            .then(data => {
              if (data.success) {
                alert('Mechanic assigned!');
              }
            });
        }
    </script>
</body>
</html>